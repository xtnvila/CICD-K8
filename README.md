# Jenkins Pipeline

Hello, this is a CICD Jenkins pipeline that automatically deploys a Java sample app to a Kubernetes cluster running over AWS EC2 instances, sounds good to you? Ok, lets get things rolling.


## SETUP & INSTRUCTIONS

The infra used in this case is composed of 3 t2.medium EC2 instances running Ubuntu Server, one for the Jenkins server, one for the Kubernetes master node and the last for the Kubernetes worker node.


### Jenkins server

Theres a few things you gotta take care of on the Jenkins server besides, obviously installing Jekins, you'll need to configure security groups to enable the inbound traffic. Also, we gonna use Maven, Git and also Docker. Don't worry all this has been previously sorted for you in the `jenkins.server.userdata.sh` file, just make sure to use that script as user data when launchin the EC2 instance and everything would be automated by AWS after booting up, you'll still need to login to the server and do:
`cat /var/lib/jenkins/secrets/initialAdminPassword` and copy it.
After this you need to login in your brand new jenkins server and go to: **Manage Jenkins > Global Tool Configuration** scroll down and click on **Add Maven** you'll need to name it and provide the value of `MAVEN_HOME` var which is `/usr/share/maven`. 
Under **Manage Jenkins > Plugin Manager** you have to add `Maven Integration`, `Docker pipeline`, `Docker` and `Deploy to container`. Also under **Advanced** scroll down to **Deploy plugin**, select **file** and use the `kubernetes-cd.hpi` included in this repo.


#### Pipeline config

With all this out of the way is time to create the actual pipeline, go to the dashboard, choose a name and select **Pipeline**. Description is optional, but make sure you check **Github project** and you add your repo URL, also check the **GitHub hook trigger for GITScm polling**.
On the Script you need to paste the `Jenkinsfile` included in this repo.
Finally, we have to add the variables, go to **Manage Jenkins > Configure System > Global properties > Environment variables** you have to fill `YOUR_DOCKERHUB_USERNAME` and `YOUR_DOCKERHUB_PWD` with your dockerhub credentials and also `ORGANIZATION_NAME` which would be your Github login, also on line 10 of the `Jenkinsfile` you have to edit `SERVICE_NAME`, this has to match your Github repo name and also would be used as your Docker image name.


### Kubernetes cluster

Now is time to launch the K8s instances, select again t2.medium, and make sure you use the `k8s.userdata.sh` to have all the dependencies installed, also take care of the security group rules to avoid connections being rejected. Now all is left to do is connect to your master node and run: `kubeadm init --pod-network-cidr=192.168.0.0/16` you will be prompted with the instructions to connect your worker node, don't worry is very simple all you have to do is copy and paste the token generated by kubeadm. 

And that's it! now the pipeline is fully configured, up and running, you can experiment with it and modify it as much as you want, if you have any questions or run into any sort of trouble feel free to reach me, have fun.

